USE master
CREATE DATABASE ApuestasF1
GO
USE ApuestasF1
GO

CREATE TABLE Usuarios (
    ID SMALLINT IDENTITY (1,1) NOT NULL CONSTRAINT PK_Usuarios PRIMARY KEY
    ,Nombre VARCHAR(30) NOT NULL
    ,Saldo SMALLMONEY NOT NULL
    ,Email VARCHAR(50) NOT NULL CONSTRAINT CK_Email CHECK (Email LIKE '%_@__%.__%')
    ,Contrasenha VARCHAR(30) NOT NULL
)

CREATE TABLE Transacciones (
    ID INT IDENTITY (1,1) NOT NULL CONSTRAINT PK_Transacciones PRIMARY KEY --> Cambio a INT, se van a generar bastantes
    ,IDUsuario SMALLINT NOT NULL CONSTRAINT FK_Transacciones FOREIGN KEY REFERENCES Usuarios(ID) ON DELETE CASCADE ON UPDATE CASCADE
    ,Fecha DATETIME NOT NULL
    ,Importe SMALLMONEY NOT NULL
    ,Concepto VARCHAR(100) NULL
)

CREATE TABLE Pilotos(
    Numero TINYINT NOT NULL CONSTRAINT PK_Pilotos PRIMARY KEY CONSTRAINT CK_Numero CHECK (Numero BETWEEN 1 AND 99)
    ,Nombre VARCHAR(30) NOT NULL
    ,Apellido VARCHAR(50) NOT NULL
    ,Siglas CHAR(3) NOT NULL
    ,Escudería CHAR(3) NOT NULL
)

CREATE TABLE Carreras (
    Código SMALLINT IDENTITY (1,1) NOT NULL CONSTRAINT PK_Carreras PRIMARY KEY 
	,Circuito VARCHAR(20) NOT NULL
	,[Fecha y Hora Fin] DATETIME NOT NULL
	,[Nº vueltas] TINYINT NOT NULL
)

CREATE TABLE PilotoCarreras(
	 [Numero Piloto] TINYINT NOT NULL CONSTRAINT FK_CódigoPiloto FOREIGN KEY REFERENCES Pilotos(Numero) ON DELETE CASCADE ON UPDATE CASCADE
	,[Código Carrera] SMALLINT NOT NULL CONSTRAINT FK_CódigoCarrera FOREIGN KEY REFERENCES Carreras(Código) ON DELETE CASCADE ON UPDATE CASCADE
	,PRIMARY KEY ([Numero Piloto], [Código Carrera])
	,Posición TINYINT NULL CONSTRAINT CK_Posicion CHECK (Posición BETWEEN 1 AND 24)
	,[Vuelta rápida] TIME NULL
)

CREATE TABLE Apuestas (
	[ID Apuesta] INT IDENTITY (1,1) NOT NULL CONSTRAINT PK_Apuestas PRIMARY KEY
	,[ID Usuario] SMALLINT NOT NULL CONSTRAINT FK_ApuestasUsuarios FOREIGN KEY REFERENCES Usuarios(ID) ON DELETE NO ACTION ON UPDATE NO ACTION
	,[Código Carrera] SMALLINT NOT NULL CONSTRAINT FK_ApuestasCarreras FOREIGN KEY REFERENCES Carreras(Código) ON DELETE NO ACTION ON UPDATE NO ACTION
	,[Código Piloto1] TINYINT NOT NULL CONSTRAINT FK_ApuestasPilotos1 FOREIGN KEY REFERENCES Pilotos(Numero) ON DELETE NO ACTION ON UPDATE NO ACTION
	,[Código Piloto2] TINYINT NULL CONSTRAINT FK_ApuestasPilotos2 FOREIGN KEY REFERENCES Pilotos(Numero) ON DELETE NO ACTION ON UPDATE NO ACTION
	,[Código Piloto3] TINYINT NULL CONSTRAINT FK_ApuestasPilotos3 FOREIGN KEY REFERENCES Pilotos(Numero) ON DELETE NO ACTION ON UPDATE NO ACTION
	,Tipo TINYINT  NOT NULL CONSTRAINT CK_Tipo CHECK (Tipo BETWEEN 1 AND 3) --	-1. Posición de un piloto 
																			--	-2. Piloto que hace la vuelta rápida
																			--	-3. Podium (primeros tres pilotos sin orden)

	,Momento SMALLDATETIME NOT NULL
	,Importe SMALLMONEY NOT NULL
	,Cuota DECIMAL(4,2) NOT NULL CONSTRAINT CK_Cuota CHECK (Cuota > 1)
)

GO

